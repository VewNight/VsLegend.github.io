# 并发挑战

##并发编程的常见问题
- 上下文切换开销问题。

- 并发过程中产生的死锁问题。

- 硬件、软件资源限制问题。


## 上下文切换问题

### 概念：
CPU通过时间片算法来执行任务，当前时间片用完后，CPU会保存当前任务状态以便下次切换回该任务时可以继续执行该任务，随后才会切换到下一个任务。任务从保存再到加载的过程就是一次上下文切换。

### 如何减少上下文开销
1. 无锁并发编程。即各个线程做事情的不同部分，最后汇总的做法。

1. CAS算法。也是无锁并发。

1. 满足条件下，使用接近最小的线程数。

1. 使用协程。


## 死锁问题
### 概念：
并发编程难免会用到锁。因此需要主要避免死锁的产生。死锁发生后，没有任何机制能解除死锁，只能强制结束JVM进程。

### 避免死锁：
- 线程获取锁的顺序要一致。

- 避免一个线程获取多个锁。

- 避免一个线程在锁内占用多个资源，尽量保证每个锁只占用一个资源（这里的资源值数据库。socket、IO等资源）。

- 尝试使用定时锁，即lock.tryLock(timeout)，避免释放锁失败。

- 对于数据库锁，加锁与解锁必须在一个数据库连接里，否在可能出现解锁失败的情况。


## 资源限制问题

### 概念：
- 资源限制指并发编程时，程序的执行速度受限于计算机硬件、软件资源。

- 硬件限制：服务器宽度上传|下载速度、硬盘读写速度、CPU处理速度等。

- 软件限制：数据库连接数、socket连接数等。


### 解决限制问题：
这类问题应当实际问题实际分析，可以考虑使用集群执行程序；资源池复用。



## 并发技巧：
> - 可变状态是至关重要的，可变状态越少，就越容易确保线程安全性。
>
> - 尽量将域声明为final类型，除非需要它们是可变的。
>
> - 不可变对象一定是线程安全的。
>
> - 封装有助于管理复杂性。将数据封装在对象中，更容易维持不变性。
>
> - 用锁来保护每一个可变变量。
>
> - 当保护同一个不可变性条件中的所有变量时，要使用同一个锁。
>
> - 在执行复合操作期间，要持有锁，保证操作的原子性。

