# 两阶段提交协议：2PC
[Two-phase commit protocol](https://en.wikipedia.org/wiki/Two-phase_commit_protocol)
[两阶段提交](https://zh.wikipedia.org/zh-hans/%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4)


## 概念
在数据库和计算机网络的事务处理中，两阶段提交协议（two-phase commit protocol：2PC）是一种原子承诺协议（atomic commitment protocol：ACP）。它是一种分布式算法，用于协调参与分布式原子事务的所有进程是否提交或中止（即回滚）事务（这是一种特殊的共识协议）。在许多临时系统故障（涉及进程，网络节点，通信等故障）的情况下，该协议也能达到其目标，因此得到了广泛的应用。

## 作用
在分布式系统中，每个节点虽然可以知晓自己的操作时成功或者失败，却无法知道其他节点的操作的成功或失败。当一个事务跨越多个节点时，为了保持事务的ACID特性，需要引入一个作为协调者（coordinator）的组件来统一掌控所有参与者（participants）节点的操作结果并最终指示这些节点是否要把操作结果进行真正的提交（比如将更新后的数据写入磁盘等等）。

## 工作方式
该分布式系统中，存在一个节点作为协调者（Coordinator），其他节点作为参与者（Participants）。

## 实现前提
2PC实现假设：
- 该分布式系统节点之间可以进行网络通信。
- 假设每个节点都带有预写日志的稳定的存储。
- 没有节点永远崩溃，且预写日志中的数据在崩溃中永远不会丢失或损坏。

前一个假设不用严格遵循，因为通常可以重新路由网络通信。后两个假设则很重要，如果一个节点被完全破坏，那么数据可能会丢失。

## 2PC算法实现
2PC算法流程概览：参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是中止操作。

在分布式事务正常执行时，协议包括两个阶段：
1. 提交请求阶段（或投票阶段）
>- 协调者节点向所有参与者节点询问是否可以执行提交操作，并开始等待各参与者节点的响应。
>- 参与者节点执行询问发起为止的所有事务操作（此时事务不会真正提交），并将Undo信息和Redo信息写入日志。
>- 各参与者节点响应协调者节点发起的询问。如果参与者节点操作成功，则它返回一个"同意"消息；如果参与者节点的事务操作实际执行失败，则它返回一个"中止"消息。

2. 提交阶段（所有参与者同意）
>- 协调者节点向所有参与者节点发出正式提交的请求。
>- 参与者节点正式完成操作，并释放在整个事务期间内占用的所有锁和资源。
>- 每个参与者都向协调员发送确认。
>- 收到所有确认后，协调器将完成事务。

2. 提交阶段（部分参与者失败或协调者超时期满）
>- 协调器将回滚消息发送给所有参与者。
>- 每个参与者都使用撤消日志来撤消事务，并释放在事务期间持有的资源和锁。
>- 每个参与者都向协调员发送确认。
>- 收到所有确认后，协调器将撤消事务。


## 优点
保证跨库事务的ACID特性。

## 缺点
**同步阻塞问题**：
>二阶段提交算法的最大缺点就在于它的执行过程中间，节点都处于阻塞状态。即节点之间在等待对方的响应消息时，它将什么也做不了。特别是，当一个节点在已经占有了某项资源的情况下，为了等待其他节点的响应消息而陷入阻塞状态时，当第三个节点尝试访问该节点占有的资源时，这个节点也将连带陷入阻塞状态。

**协调者单点问题**：
>协调者节点指示参与者节点进行提交等操作时，如有参与者节点出现了崩溃等情况而导致协调者始终无法获取所有参与者的响应信息，这时协调者将只能依赖协调者自身的超时机制来生效。但往往超时机制生效时，协调者都会指示参与者进行回滚操作。这样的策略显得比较保守。

**数据不一致问题**：
>两阶段提交协议虽然是分布式数据强一致性所设计，但仍然存在数据不一致性的可能性。比如在第二阶段中，假设协调者发出了事务 commit 通知，但是因为网络问题该通知仅被一部分参与者所收到并执行了commit 操作，其余的参与者则因为没有收到通知一直处于阻塞状态，这时候就产生了数据的不一致性。